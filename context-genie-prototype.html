<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Context Genie ‚Äì High Fidelity Prototype</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <style>
    :root {
      color-scheme: light;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      --bg: #f1f3f9;
      --shell: #ffffff;
      --border: #cfd5ea;
      --chip-bg: rgba(99, 102, 241, 0.08);
      --chip-text: #2c2f65;
      --text-secondary: #54638c;
      --accent: #7c3aed;
      --accent-dark: #5b21b6;
      --danger: #ef4444;
      --Weak: #4c51bf;
      --balanced: #059669;
      --Strong: #ef4444;
      --keyboard-key: #f5f7fb;
      --keyboard-border: #d9deef;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(160deg, #dfe6ff 0%, #f8f5ff 40%, #fff8f5 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 48px 24px;
      color: #121735;
    }

    .phone-shell {
      position: relative;
      width: min(400px, 100%);
      max-width: 380px;
      height: 760px;
      border-radius: 36px;
      padding: 24px 18px 32px;
      background: var(--shell);
      box-shadow: 0 40px 60px -40px rgba(28, 31, 53, 0.4), 0 20px 30px rgba(28, 31, 53, 0.08);
      border: 1px solid rgba(0, 0, 0, 0.04);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .notch {
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      width: 130px;
      height: 18px;
      background: #111218;
      border-radius: 9px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: 600;
      color: #0e1537;
    }

    header .contact {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header .contact .avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6d28d9, #5eead4);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
    }

    header .icons {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .thread {
      flex: 1;
      background: linear-gradient(180deg, #f8fbff 0%, #ffffff 100%);
      border-radius: 22px;
      padding: 24px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      border: 1px solid rgba(99, 102, 241, 0.08);
    }

    .bubble {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.4;
      color: #111b3a;
    }

    .bubble.incoming {
      background: #f1f4ff;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    .bubble.outgoing {
      background: linear-gradient(135deg, rgba(124, 58, 237, 0.88), rgba(99, 102, 241, 0.88));
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .composer {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .suggestion-bar {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }

    .chip {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px 6px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      background: var(--chip-bg);
      color: var(--chip-text);
      border: 1px solid transparent;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .chip:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 12px -8px rgba(17, 24, 39, 0.3);
    }

    .chip.auto {
      background: linear-gradient(135deg, rgba(124, 58, 237, 0.16), rgba(99, 102, 241, 0.12));
      border-color: rgba(124, 58, 237, 0.32);
    }

    .chip[data-language="en"] {
      background: rgba(99, 102, 241, 0.12);
      border-color: rgba(99, 102, 241, 0.24);
      color: #3730a3;
    }

    .chip[data-language="ru"] {
      background: rgba(139, 92, 246, 0.16);
      border-color: rgba(124, 58, 237, 0.22);
      color: #4c1d95;
    }

    .chip[data-language="id"] {
      background: rgba(16, 185, 129, 0.14);
      border-color: rgba(5, 150, 105, 0.22);
      color: #047857;
    }

    .chip[data-language="slang"] {
      background: rgba(249, 115, 22, 0.14);
      border-color: rgba(234, 88, 12, 0.24);
      color: #c2410c;
    }

    .chip[data-language="emoji"] {
      background: rgba(236, 72, 153, 0.14);
      border-color: rgba(236, 72, 153, 0.24);
      color: #be185d;
    }

    .chip .language-tag {
      position: absolute;
      top: 4px;
      right: 6px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      opacity: 0.8;
    }

    .composer-field {
      position: relative;
      background: var(--bg);
      border-radius: 18px;
      border: 1.5px solid var(--border);
      padding: 14px 16px;
      display: grid;
      grid-template-columns: 1fr 58px;
      align-items: center;
      gap: 12px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .composer-field:focus-within {
      border-color: rgba(124, 58, 237, 0.65);
      box-shadow: 0 16px 30px -24px rgba(124, 58, 237, 0.6);
    }

    .composer-field textarea {
      background: transparent;
      border: none;
      resize: none;
      font-size: 15px;
      font-family: inherit;
      line-height: 1.45;
      color: #121632;
      outline: none;
      min-height: 52px;
    }

    .genie-toggle {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .genie-toggle button {
      width: 52px;
      height: 52px;
      border-radius: 18px;
      border: none;
      font-weight: 700;
      color: white;
      background: linear-gradient(140deg, #8b5cf6, #6366f1);
      box-shadow: 0 12px 30px -15px rgba(79, 70, 229, 0.9);
      cursor: pointer;
      transition: transform 0.18s ease, box-shadow 0.18s ease;
    }

    .genie-toggle button.inactive {
      background: linear-gradient(150deg, #a3a7c7, #6b7280);
      box-shadow: none;
    }

    .genie-toggle button:active {
      transform: scale(0.96);
    }

    .genie-toggle span {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .keyboard {
      background: rgba(15, 23, 42, 0.02);
      border-radius: 28px;
      padding: 20px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      display: grid;
      grid-template-columns: repeat(10, minmax(0, 1fr));
      gap: 10px;
    }

    .key {
      height: 44px;
      background: var(--keyboard-key);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 15px;
      color: #1f2937;
      border: 1px solid var(--keyboard-border);
      box-shadow: inset 0 -2px 0 rgba(148, 163, 184, 0.2);
    }

    .key.special {
      grid-column: span 2;
    }

    .key.space {
      grid-column: span 4;
    }

    .key.send {
      grid-column: span 2;
      background: linear-gradient(140deg, #6366f1, #14b8a6);
      color: white;
      border: none;
      box-shadow: 0 10px 20px -16px rgba(15, 118, 110, 0.8);
    }

    .overlay {
      position: absolute;
      left: 18px;
      right: 18px;
      bottom: 120px;
      background: rgba(15, 23, 42, 0.56);
      border-radius: 24px;
      padding: 2px;
      transform: translateY(120%);
      opacity: 0;
      pointer-events: none;
      transition: transform 0.35s cubic-bezier(0.25, 0.9, 0.4, 1), opacity 0.35s ease;
      backdrop-filter: blur(14px);
    }

    .overlay.visible {
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto;
    }

    .overlay-inner {
      background: #101324;
      border-radius: 22px;
      padding: 22px 24px 26px;
      color: white;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .overlay-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .overlay-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
    }

    .overlay-header button {
      background: rgba(255, 255, 255, 0.12);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    .slider-group {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .slider-label {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
    }

    .slider-label span {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.72);
    }

    .slider-label strong {
      font-size: 16px;
      color: white;
    }

    .slider-track {
      position: relative;
    }

    .slider-track input[type="range"] {
      width: 100%;
      appearance: none;
      -webkit-appearance: none;
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(76, 81, 191, 0.4) 0%, rgba(59, 130, 246, 0.5) 40%, rgba(99, 102, 241, 0.9) 100%);
      outline: none;
    }

    .slider-track input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: linear-gradient(135deg, #a855f7, #6366f1);
      border: 3px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 12px 24px -18px rgba(139, 92, 246, 0.9);
      cursor: pointer;
    }

    .slider-track input[type="range"]::-moz-range-thumb {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: linear-gradient(135deg, #a855f7, #6366f1);
      border: 3px solid rgba(255, 255, 255, 0.9);
      cursor: pointer;
    }

    .slider-badges {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.45);
      letter-spacing: 0.08em;
    }

    .accent-Weak {
      color: #cbd5f5;
    }

    .accent-balanced {
      color: #bbf7d0;
    }

    .accent-Strong {
      color: #fecaca;
    }

    .dictionary-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .dictionary-pills .pill {
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.02em;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .input-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.85);
      margin-bottom: 8px;
      letter-spacing: 0.02em;
    }

    .input-label span {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.45);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .api-key-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .api-key-row input {
      flex: 1;
      padding: 10px 14px;
      border-radius: 12px;
      border: none;
      background: rgba(255, 255, 255, 0.12);
      color: white;
      font-size: 14px;
    }

    .api-key-row input::placeholder {
      color: rgba(255, 255, 255, 0.35);
    }

    .api-key-row button {
      padding: 10px 14px;
      border-radius: 12px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      background: rgba(124, 58, 237, 0.85);
      color: white;
      letter-spacing: 0.02em;
    }

    .api-key-row button.secondary {
      background: rgba(255, 255, 255, 0.16);
      color: rgba(255, 255, 255, 0.85);
    }

    .status-banner {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 14px;
      background: rgba(99, 102, 241, 0.14);
      color: #1e1b4b;
      font-size: 13px;
      font-weight: 500;
    }

    .status-banner[data-mode="Weak"] {
      background: rgba(76, 81, 191, 0.14);
      color: #312e81;
    }

    .status-banner[data-mode="balanced"] {
      background: rgba(5, 150, 105, 0.12);
      color: #064e3b;
    }

    .status-banner[data-mode="Strong"] {
      background: rgba(239, 68, 68, 0.12);
      color: #7f1d1d;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: currentColor;
      opacity: 0.6;
    }

    .microcopy {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.68);
      line-height: 1.5;
    }

    .api-status {
      margin-top: 6px;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.55);
    }

    footer {
      text-align: center;
      font-size: 12px;
      color: #6b7280;
      margin-top: 18px;
    }

    .hint {
      font-size: 12px;
      color: var(--text-secondary);
      text-align: center;
      margin-top: -4px;
    }
  </style>
</head>
<body>
  <div class="phone-shell" role="application" aria-label="Context Genie prototype">
    <div class="notch" aria-hidden="true"></div>
    <header>
      <div class="contact">
        <span id="time">1:25</span>
        <span>‚Äπ</span>
        <div class="avatar">H</div>
        <span>Heather</span>
      </div>
      <div class="icons">
        <span>5G</span>
        <span>ÙÄìá</span>
      </div>
    </header>

    <div class="thread" aria-live="polite">
      <div class="bubble incoming">Hey! Let‚Äôs keep it casual in English but I‚Äôll try some Russian phrases.</div>
      <div class="bubble outgoing">Sounds good! I'll sprinkle in some slang too.</div>
      <div class="bubble incoming">–ö–∞–∫ –¥–µ–ª–∞? Need anything from the store?</div>
    </div>

    <div class="composer">
      <div class="status-banner" data-mode="balanced" id="modeBanner">
        <div class="status-dot"></div>
        <span id="modeMessage">Genie adapting tone and language automatically.</span>
      </div>

      <div class="suggestion-bar" id="suggestionBar">
        <!-- suggestions injected here -->
      </div>

      <div class="composer-field">
        <textarea id="composer" placeholder="Draft your reply‚Ä¶" aria-label="Message composer with Context Genie suggestions"></textarea>
        <div class="genie-toggle">
          <button id="genieButton">GENIE</button>
          <span id="genieState">Active</span>
        </div>
      </div>
      <p class="hint">Single tap to toggle Genie. Double tap to open personalization menu.</p>
    </div>

    <div class="keyboard">
      <div class="key">Q</div>
      <div class="key">W</div>
      <div class="key">E</div>
      <div class="key">R</div>
      <div class="key">T</div>
      <div class="key">Y</div>
      <div class="key">U</div>
      <div class="key">I</div>
      <div class="key">O</div>
      <div class="key">P</div>

      <div class="key">A</div>
      <div class="key">S</div>
      <div class="key">D</div>
      <div class="key">F</div>
      <div class="key">G</div>
      <div class="key">H</div>
      <div class="key">J</div>
      <div class="key">K</div>
      <div class="key">L</div>
      <div class="key special">‚å´</div>

      <div class="key special">‚áß</div>
      <div class="key">Z</div>
      <div class="key">X</div>
      <div class="key">C</div>
      <div class="key">V</div>
      <div class="key">B</div>
      <div class="key">N</div>
      <div class="key">M</div>
      <div class="key special">,</div>
      <div class="key special">.</div>

      <div class="key special">123</div>
      <div class="key space">space</div>
      <div class="key send">send</div>
    </div>

    <footer>Context Genie prototype ‚Ä¢ LLM-informed multilingual suggestions</footer>

    <div class="overlay" id="genieOverlay" aria-hidden="true">
      <div class="overlay-inner">
        <div class="overlay-header">
          <h2>Context Genie Controls</h2>
          <button id="closeOverlay">Done</button>
        </div>

        <div class="slider-group">
          <div class="slider-label">
            <strong id="modeLabel">Balanced Guidance</strong>
            <span id="modeDescriptor">Keeps tone aligned while letting you drive.</span>
          </div>
          <div class="slider-track">
            <input type="range" id="overrideSlider" min="0" max="100" value="55">
          </div>
          <div class="slider-badges">
            <span class="accent-Weak">Weak</span>
            <span class="accent-balanced">Balanced</span>
            <span class="accent-Strong">Strong</span>
          </div>
        </div>

        <div>
          <h3 style="margin: 0 0 10px; font-size: 15px; letter-spacing: 0.02em;">Active Dictionaries</h3>
          <div class="dictionary-pills" id="dictionaryPills">
            <span class="pill">English ‚Äì Casual (LLM)</span>
            <span class="pill">Russian ‚Äì Cyrillic (LLM)</span>
            <span class="pill">Bahasa ‚Äì Slang (LLM)</span>
            <span class="pill">Emoji/Social Tone</span>
          </div>
        </div>

        <div>
          <h3 style="margin: 16px 0 10px; font-size: 15px; letter-spacing: 0.02em;">LLM Connector</h3>
          <label class="input-label" for="apiKeyInput">
            API Key
            <span>optional</span>
          </label>
          <div class="api-key-row">
            <input type="password" id="apiKeyInput" placeholder="sk-..." autocomplete="off">
            <button id="saveApiKey">Save</button>
            <button id="clearApiKey" class="secondary">Clear</button>
          </div>
          <p class="microcopy api-status" id="apiKeyStatus">Stored locally in this browser. Sent with each request only when populated.</p>
        </div>

        <div class="microcopy">
          Genie uses local context + recipient profile + on-device LLM priors.
          In Strong mode Genie can override your draft; in Weak mode it never changes your text without a tap.
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:8000/api';
    const conversationContext = [
      "Hey! Let‚Äôs keep it casual in English but I‚Äôll try some Russian phrases.",
      "Sounds good! I'll sprinkle in some slang too.",
      "–ö–∞–∫ –¥–µ–ª–∞? Need anything from the store?"
    ];
    const languagePreferences = ['en', 'ru', 'id', 'slang'];

    const MODE_COPY = {
      Weak: {
        label: 'Listening Only',
        banner: 'Genie observing. Tap a chip to accept.',
        descriptor: 'Suggestions match tone but never change your draft.',
        bannerMode: 'Weak'
      },
      balanced: {
        label: 'Balanced Guidance',
        banner: 'Genie adapting tone and language automatically.',
        descriptor: 'Genie keeps context aligned and prompts you at the right moments.',
        bannerMode: 'balanced'
      },
      Strong: {
        label: 'Turbo Rewrite',
        banner: 'Genie will auto-upgrade slang, tone, and language mid-phrase.',
        descriptor: 'Prioritizes seamless flow; overrides appear inline with undo support.',
        bannerMode: 'Strong'
      }
    };

    const FALLBACK_LIBRARY = [
      {
        pattern: /^k(?:ak|ag)/i,
        suggestions: [
          { text: '–ö–∞–∫ –¥–µ–ª–∞?', language: 'ru', label: 'RU', explanation: 'Standard Cyrillic greeting in Russian.', confidence: 0.82 },
          { text: 'Kak dil√°?', language: 'id', label: 'ID', explanation: 'Bahasa slang spelling preserving intent.', confidence: 0.58 },
          { text: '–ö–∞–∫ —Ç—ã?', language: 'ru', label: 'RU', explanation: 'Alternative Russian phrasing for familiarity.', confidence: 0.7 },
          { text: 'Kak are you?', language: 'mix', label: 'Mix', explanation: 'Playful code-mixed option.', confidence: 0.52 }
        ]
      },
      {
        pattern: /^priv/i,
        suggestions: [
          { text: '–ü—Ä–∏–≤–µ—Ç!', language: 'ru', label: 'RU', explanation: 'Primary greeting in Russian.', confidence: 0.86 },
          { text: 'Privet ü§ó', language: 'emoji', label: 'üôÇ', explanation: 'Adds emoji flair while staying informal.', confidence: 0.64 },
          { text: 'Hey!', language: 'en', label: 'EN', explanation: 'Switch back to English tone.', confidence: 0.62 },
          { text: 'Halo!', language: 'id', label: 'ID', explanation: 'Indonesian casual greeting.', confidence: 0.55 }
        ]
      },
      {
        pattern: /^im/i,
        suggestions: [
          { text: "I'm", language: 'en', label: 'EN', explanation: 'Standard English contraction.', confidence: 0.92 },
          { text: 'Imma', language: 'slang', label: 'SL', explanation: 'US slang contraction for informal plans.', confidence: 0.7 },
          { text: '–Ø', language: 'ru', label: 'RU', explanation: 'Russian equivalent in Cyrillic.', confidence: 0.74 },
          { text: 'Saya', language: 'id', label: 'ID', explanation: 'Neutral Bahasa Indonesian pronoun.', confidence: 0.66 }
        ]
      },
      {
        pattern: /^ya$/i,
        suggestions: [
          { text: '–Ø', language: 'ru', label: 'RU', explanation: 'Switches to Cyrillic for Russian.', confidence: 0.78 },
          { text: 'ya', language: 'slang', label: 'SL', explanation: 'Keeps informal Latin transliteration.', confidence: 0.6 },
          { text: 'I', language: 'en', label: 'EN', explanation: 'Reverts to neutral English tone.', confidence: 0.58 },
          { text: 'yaaa ü§ü', language: 'emoji', label: 'üôÇ', explanation: 'Stylized slang variant with emoji.', confidence: 0.5 }
        ]
      },
      {
        pattern: /^wass?/i,
        suggestions: [
          { text: "What's up?", language: 'en', label: 'EN', explanation: 'Standard English autocorrect.', confidence: 0.88 },
          { text: 'Wassup!', language: 'slang', label: 'SL', explanation: 'Friendly slang alternative.', confidence: 0.73 },
          { text: '–ö–∞–∫ —Ç—ã?', language: 'ru', label: 'RU', explanation: 'Switches tone to Russian informal.', confidence: 0.68 },
          { text: 'Apa kabar?', language: 'id', label: 'ID', explanation: 'Formal Bahasa greeting.', confidence: 0.6 }
        ]
      },
      {
        pattern: /^ty$/i,
        suggestions: [
          { text: '—Ç—ã', language: 'ru', label: 'RU', explanation: 'Informal Russian ‚Äúyou‚Äù.', confidence: 0.72 },
          { text: 'tu', language: 'slang', label: 'Mix', explanation: 'Spanglish style mix.', confidence: 0.54 },
          { text: 'you', language: 'en', label: 'EN', explanation: 'Standard English correction.', confidence: 0.76 },
          { text: 'kamu', language: 'id', label: 'ID', explanation: 'Neutral Bahasa Indonesian address.', confidence: 0.6 }
        ]
      },
      {
        pattern: /^ion\s?even\s?know/i,
        suggestions: [
          { text: 'fr', language: 'slang', label: 'SL', explanation: 'Affirms confusion with casual emphasis.', confidence: 0.64 },
          { text: 'bro', language: 'slang', label: 'SL', explanation: 'Adds a familiar, informal tone.', confidence: 0.58 },
          { text: 'what to say', language: 'slang', label: 'SL', explanation: 'Extends the uncertainty naturally.', confidence: 0.55 },
          { text: 'for real tho', language: 'slang', label: 'SL', explanation: 'Strengthens the expression of not knowing.', confidence: 0.57 }
        ]
      },
      {
        pattern: /^no\s?cap/i,
        suggestions: [
          { text: 'that‚Äôs facts', language: 'slang', label: 'SL', explanation: 'Reinforces sincerity and truthfulness.', confidence: 0.68 },
          { text: 'for real', language: 'slang', label: 'SL', explanation: 'Confirms honesty in a casual tone.', confidence: 0.64 },
          { text: 'on god', language: 'slang', label: 'SL', explanation: 'Common intensifier paired with no cap.', confidence: 0.6 },
          { text: 'i swear', language: 'slang', label: 'SL', explanation: 'Extends the claim of honesty.', confidence: 0.58 }
        ]
      },
      {
        pattern: /^bet$/i,
        suggestions: [
          { text: 'say less', language: 'slang', label: 'SL', explanation: 'Signals immediate agreement.', confidence: 0.7 },
          { text: "i'm on it", language: 'slang', label: 'SL', explanation: 'Shows readiness to act.', confidence: 0.64 },
          { text: 'for sure', language: 'slang', label: 'SL', explanation: 'Confirms agreement in casual tone.', confidence: 0.62 },
          { text: 'we locked', language: 'slang', label: 'SL', explanation: 'Adds commitment to the agreement.', confidence: 0.6 }
        ]
      },
      {
        pattern: /^i'?m\sdead/i,
        suggestions: [
          { text: 'bro', language: 'slang', label: 'SL', explanation: 'Adds emphasis to expressive reaction.', confidence: 0.63 },
          { text: 'this got me weak', language: 'slang', label: 'SL', explanation: 'Extends the humor-based reaction.', confidence: 0.66 },
          { text: 'lmao fr', language: 'slang', label: 'SL', explanation: 'Strengthens the comedic response.', confidence: 0.61 },
          { text: "i can't", language: 'slang', label: 'SL', explanation: 'Short expressive reaction to keep tone playful.', confidence: 0.58 }
        ]
      },
      {
        pattern: /^lowkey/i,
        suggestions: [
          { text: 'kinda', language: 'slang', label: 'SL', explanation: 'Softens or qualifies the statement.', confidence: 0.65 },
          { text: 'wanna do it', language: 'slang', label: 'SL', explanation: 'Completes a common lowkey sentiment.', confidence: 0.62 },
          { text: 'think so', language: 'slang', label: 'SL', explanation: 'Adds subtle agreement or leaning.', confidence: 0.6 },
          { text: 'not gonna lie', language: 'slang', label: 'SL', explanation: 'Pairs naturally to reveal honesty.', confidence: 0.59 }
        ]
      },
      {
        pattern: /^finna/i,
        suggestions: [
          { text: 'head out soon', language: 'slang', label: 'SL', explanation: 'Signals you are about to leave.', confidence: 0.64 },
          { text: 'make moves', language: 'slang', label: 'SL', explanation: 'Casual plan to get going.', confidence: 0.6 },
          { text: 'grab something', language: 'slang', label: 'SL', explanation: 'Hints at a quick errand.', confidence: 0.57 },
          { text: 'bounce fr', language: 'slang', label: 'SL', explanation: 'Emphasizes leaving immediately.', confidence: 0.55 }
        ]
      },
      {
        pattern: /^brb/i,
        suggestions: [
          { text: 'grabbing food', language: 'slang', label: 'SL', explanation: 'Friendly status while stepping away.', confidence: 0.68 },
          { text: 'need a sec', language: 'slang', label: 'SL', explanation: 'Quick notice you will return soon.', confidence: 0.63 },
          { text: 'hold up', language: 'slang', label: 'SL', explanation: 'Informal pause request.', confidence: 0.6 },
          { text: 'back in a min', language: 'slang', label: 'SL', explanation: 'Short promise to return quickly.', confidence: 0.58 }
        ]
      },
      {
        pattern: /^smh/i,
        suggestions: [
          { text: "y'all wild", language: 'slang', label: 'SL', explanation: 'Playful judgment while shaking your head.', confidence: 0.66 },
          { text: 'can‚Äôt believe it', language: 'slang', label: 'SL', explanation: 'Extends the disbelief sentiment.', confidence: 0.61 },
          { text: 'do better', language: 'slang', label: 'SL', explanation: 'Light reprimand delivered casually.', confidence: 0.57 },
          { text: 'for real?', language: 'slang', label: 'SL', explanation: 'Questions the situation with disbelief.', confidence: 0.56 }
        ]
      }
    ];

    const FALLBACK_DEFAULT = [
      { text: 'Yu', language: 'slang', label: 'SL', explanation: 'Keeping relaxed tone for close friends.', confidence: 0.55 },
      { text: "I'm", language: 'en', label: 'EN', explanation: 'Standard English correction.', confidence: 0.9 },
      { text: '–¢—ã', language: 'ru', label: 'RU', explanation: 'Cyrillic alternative using capitalized form.', confidence: 0.7 },
      { text: 'Imma', language: 'slang', label: 'SL', explanation: 'US slang contraction for informal plans.', confidence: 0.65 }
    ];

    const genieButton = document.getElementById('genieButton');
    const genieStateLabel = document.getElementById('genieState');
    const overlay = document.getElementById('genieOverlay');
    const closeOverlay = document.getElementById('closeOverlay');
    const overrideSlider = document.getElementById('overrideSlider');
    const modeLabel = document.getElementById('modeLabel');
    const modeDescriptor = document.getElementById('modeDescriptor');
    const modeBanner = document.getElementById('modeBanner');
    const modeMessage = document.getElementById('modeMessage');
    const composer = document.getElementById('composer');
    const suggestionBar = document.getElementById('suggestionBar');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const saveApiKeyButton = document.getElementById('saveApiKey');
    const clearApiKeyButton = document.getElementById('clearApiKey');
    const apiKeyStatus = document.getElementById('apiKeyStatus');

    const genieState = {
      enabled: true,
      mode: 'balanced',
      apiKey: loadApiKey(),
      debounceTimer: null,
      inFlight: null,
      lastAutoOverride: '',
      suppressInput: false,
      fallbackActive: false
    };

    let doubleTapTimeout = null;
    let bannerTimeout = null;
    let currentSuggestions = FALLBACK_DEFAULT.map(cloneSuggestion);

    function loadApiKey() {
      return localStorage.getItem('contextGenieApiKey') || '';
    }

    function persistApiKey(value) {
      if (value) {
        localStorage.setItem('contextGenieApiKey', value);
      } else {
        localStorage.removeItem('contextGenieApiKey');
      }
    }

    function cloneSuggestion(item) {
      return {
        text: item.text,
        language: item.language,
        label: item.label || (item.language || '').toUpperCase(),
        explanation: item.explanation || '',
        autoApply: Boolean(item.autoApply),
        confidence: typeof item.confidence === 'number' ? item.confidence : 0.6
      };
    }

    function escapeHtml(value) {
      return (value || '').replace(/[&<>"']/g, (char) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      })[char]);
    }

    function offlineSuggestions(word, fullText = '') {
      const trailingDraft = fullText ? fullText.slice(-48).trim() : '';
      const entry = FALLBACK_LIBRARY.find((item) => {
        return item.pattern.test(word) || (trailingDraft && item.pattern.test(trailingDraft));
      });
      const suggestions = entry ? entry.suggestions : FALLBACK_DEFAULT;
      return suggestions.map(cloneSuggestion);
    }

    function renderSuggestionChips(suggestions) {
      currentSuggestions = suggestions;
      if (!suggestions.length) {
        suggestionBar.innerHTML = '<span class="microcopy" style="grid-column:1 / -1;text-align:center;">No suggestions</span>';
        return;
      }
      suggestionBar.innerHTML = suggestions.map((suggestion, index) => `
        <button class="chip ${suggestion.autoApply ? 'auto' : ''}" data-language="${suggestion.language}" data-index="${index}" type="button" title="${escapeHtml(suggestion.explanation)}">
          ${escapeHtml(suggestion.text)}
          <span class="language-tag">${escapeHtml(suggestion.label)}</span>
        </button>
      `).join('');
    }

    function refreshModeBanner() {
      clearTimeout(bannerTimeout);
      const copy = MODE_COPY[genieState.mode];
      modeBanner.dataset.mode = copy.bannerMode;
      modeMessage.textContent = copy.banner;
    }

    function setBannerMessage(message, { persist = false, duration = 2200 } = {}) {
      clearTimeout(bannerTimeout);
      modeMessage.textContent = message;
      if (!persist) {
        bannerTimeout = setTimeout(refreshModeBanner, duration);
      }
    }

    function handleSuggestionsResponse(payload, { isFallback = false } = {}) {
      genieState.fallbackActive = isFallback;
      const suggestions = (payload.suggestions || []).map((item) => ({
        text: item.text,
        language: item.language,
        label: item.label || (item.language || '').toUpperCase(),
        explanation: item.explanation || '',
        autoApply: Boolean(item.autoApply),
        confidence: typeof item.confidence === 'number' ? item.confidence : 0.6
      }));

      if (!genieState.enabled || genieState.mode !== 'Strong') {
        suggestions.forEach((suggestion) => {
          suggestion.autoApply = false;
        });
      }

      let autoOverride = null;
      if (genieState.enabled && genieState.mode === 'Strong' && suggestions[0]?.autoApply) {
        autoOverride = suggestions[0].text;
      }
      if (genieState.enabled && genieState.mode === 'Strong' && payload.autoOverride) {
        autoOverride = payload.autoOverride;
        if (suggestions[0]) {
          suggestions[0].autoApply = true;
        }
      }

      renderSuggestionChips(suggestions);

      if (isFallback) {
        setBannerMessage('Genie offline ‚Äì using on-device heuristics.', { duration: 2600 });
      } else if (payload.usedLLM && genieState.apiKey) {
        setBannerMessage('Genie used your API key for this set.', { duration: 2500 });
      } else {
        refreshModeBanner();
      }

      if (
        autoOverride &&
        autoOverride !== genieState.lastAutoOverride &&
        genieState.mode === 'Strong'
      ) {
        genieState.lastAutoOverride = autoOverride;
        applySuggestionText(autoOverride, { source: 'auto' });
        setBannerMessage('Genie auto-upgraded your phrase for tone.', { duration: 2300 });
      }
    }

    function getCursorWord() {
      const cursor = composer.selectionStart ?? composer.value.length;
      const text = composer.value.slice(0, cursor);
      const match = text.match(/([\p{L}\p{N}'‚Äô\-]+)$/u);
      return match ? match[0] : '';
    }

    function cancelInFlight() {
      if (genieState.inFlight) {
        genieState.inFlight.abort();
        genieState.inFlight = null;
      }
    }

    async function requestSuggestions() {
      if (!genieState.enabled) {
        renderSuggestionChips(offlineSuggestions(getCursorWord(), composer.value));
        return;
      }

      cancelInFlight();
      const controller = new AbortController();
      genieState.inFlight = controller;
      const cursorWord = getCursorWord();
      const body = {
        text: composer.value,
        cursorWord,
        mode: genieState.mode,
        conversation: conversationContext,
        languagePreferences
      };
      if (genieState.apiKey) {
        body.apiKey = genieState.apiKey;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/context-genie/suggest`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body),
          signal: controller.signal
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        if (!controller.signal.aborted) {
          handleSuggestionsResponse(data, { isFallback: false });
        }
      } catch (error) {
        if (!controller.signal.aborted) {
          const fallbackPayload = {
            usedLLM: false,
            suggestions: offlineSuggestions(cursorWord, composer.value),
            autoOverride: null
          };
          handleSuggestionsResponse(fallbackPayload, { isFallback: true });
        }
      } finally {
        if (genieState.inFlight === controller) {
          genieState.inFlight = null;
        }
      }
    }

    function scheduleSuggestionFetch() {
      clearTimeout(genieState.debounceTimer);
      genieState.debounceTimer = setTimeout(requestSuggestions, 220);
    }

    function placeCursorAtEnd() {
      const position = composer.value.length;
      composer.setSelectionRange(position, position);
    }

    function applySuggestionText(text, { source = 'chip', suggestion = null } = {}) {
      const trimmed = composer.value.trimEnd();
      const words = trimmed ? trimmed.split(/\s+/) : [];
      if (words.length === 0) {
        words.push(text);
      } else {
        words[words.length - 1] = text;
      }
      genieState.suppressInput = true;
      composer.value = words.join(' ') + ' ';
      placeCursorAtEnd();
      genieState.suppressInput = false;

      if (source === 'chip' && suggestion) {
        setBannerMessage(`Applied ${suggestion.label} suggestion.`);
      }
      if (source === 'auto') {
        scheduleSuggestionFetch();
      }
    }

    function toggleGenie() {
      genieState.enabled = !genieState.enabled;
      genieButton.classList.toggle('inactive', !genieState.enabled);
      genieStateLabel.textContent = genieState.enabled ? 'Active' : 'Off';
      modeBanner.style.display = genieState.enabled ? 'flex' : 'none';
      if (genieState.enabled) {
        refreshModeBanner();
        scheduleSuggestionFetch();
      } else {
        cancelInFlight();
        setBannerMessage('Genie paused. Suggestions frozen.', { duration: 2200 });
      }
    }

    function updateModeFromSlider(value) {
      const previousMode = genieState.mode;
      if (value <= 33) {
        genieState.mode = 'Weak';
      } else if (value >= 67) {
        genieState.mode = 'Strong';
      } else {
        genieState.mode = 'balanced';
      }

      const copy = MODE_COPY[genieState.mode];
      modeLabel.textContent = copy.label;
      modeDescriptor.textContent = copy.descriptor;
      modeBanner.dataset.mode = copy.bannerMode;

      if (previousMode !== genieState.mode) {
        genieState.lastAutoOverride = '';
        if (genieState.enabled) {
          scheduleSuggestionFetch();
        } else {
          refreshModeBanner();
        }
      } else {
        refreshModeBanner();
      }
    }

    function updateApiKeyUI() {
      apiKeyInput.value = genieState.apiKey;
      apiKeyStatus.textContent = genieState.apiKey
        ? 'Using stored key for LLM calls (never logged).'
        : 'No key set. Backend will fall back to heuristics.';
    }

    genieButton.addEventListener('click', () => {
      if (doubleTapTimeout !== null) {
        return;
      }
      doubleTapTimeout = setTimeout(() => {
        toggleGenie();
        clearTimeout(doubleTapTimeout);
        doubleTapTimeout = null;
      }, 220);
    });

    genieButton.addEventListener('dblclick', () => {
      clearTimeout(doubleTapTimeout);
      doubleTapTimeout = null;
      toggleOverlay(true);
    });

    function toggleOverlay(show) {
      overlay.classList.toggle('visible', show);
      overlay.setAttribute('aria-hidden', String(!show));
      if (show) {
        updateApiKeyUI();
        setTimeout(() => apiKeyInput.focus({ preventScroll: true }), 120);
      }
    }

    closeOverlay.addEventListener('click', () => toggleOverlay(false));

    overrideSlider.addEventListener('input', (event) => {
      updateModeFromSlider(Number(event.target.value));
    });

    composer.addEventListener('input', () => {
      if (genieState.suppressInput) {
        return;
      }
      genieState.lastAutoOverride = '';
      if (genieState.enabled) {
        scheduleSuggestionFetch();
      } else {
        renderSuggestionChips(offlineSuggestions(getCursorWord(), composer.value));
      }
    });

    suggestionBar.addEventListener('click', (event) => {
      const chip = event.target.closest('.chip');
      if (!chip) return;
      const suggestion = currentSuggestions[Number(chip.dataset.index)];
      if (!suggestion) return;
      applySuggestionText(suggestion.text, { source: 'chip', suggestion });
    });

    saveApiKeyButton.addEventListener('click', () => {
      const value = apiKeyInput.value.trim();
      genieState.apiKey = value;
      persistApiKey(value);
      updateApiKeyUI();
      setBannerMessage('API key saved locally.', { duration: 2000 });
    });

    clearApiKeyButton.addEventListener('click', () => {
      genieState.apiKey = '';
      persistApiKey('');
      apiKeyInput.value = '';
      updateApiKeyUI();
      setBannerMessage('API key cleared.', { duration: 2000 });
    });

    overlay.addEventListener('click', (event) => {
      if (event.target === overlay) {
        toggleOverlay(false);
      }
    });

    // Kick off initial render
    updateModeFromSlider(Number(overrideSlider.value));
    refreshModeBanner();
    renderSuggestionChips(offlineSuggestions('', composer.value));
    scheduleSuggestionFetch();
  </script>
</body>
</html>
